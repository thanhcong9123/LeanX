@using System.IO
@using LearnX_ModelView.Catalog.EssaySubmission
@model LearnX_ModelView.Catalog.EssaySubmission.EssaySubmissionRequest

@{
    ViewData["Title"] = "Chi tiết bài nộp";
}

<link rel="stylesheet" href="~/css/submission/viewSubmissionDetail.css" />

<div class="app-container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow-card">
                <div class="card-header gradient-primary text-white">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-file-alt"></i> Chi tiết bài nộp
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Thông tin cơ bản -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="info-card">
                                <h6 class="info-title"><i class="fas fa-info-circle text-primary"></i> Thông tin bài nộp</h6>
                                <p><strong>ID:</strong> #@Model.Id</p>
                                <p><strong>Lần nộp:</strong> @Model.AttemptNumber</p>
                                <p><strong>Thời gian nộp:</strong> @Model.SubmittedAt.ToString("dd/MM/yyyy HH:mm:ss")</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-card">
                                <h6 class="info-title"><i class="fas fa-tasks text-success"></i> Trạng thái</h6>
                                <p>
                                    <strong>Hiện tại:</strong>
                                    @switch (Model.Status)
                                    {
                                        case "Submitted":
                                            <span class="badge badge-warning badge-lg"><i class="fas fa-clock"></i> Chờ chấm</span>
                                            break;
                                        case "Graded":
                                            <span class="badge badge-success badge-lg"><i class="fas fa-check"></i> Đã chấm</span>
                                            break;
                                        case "Reviewed":
                                            <span class="badge badge-accent badge-lg"><i class="fas fa-star"></i> Đã duyệt</span>
                                            break;
                                        default:
                                            <span class="badge badge-secondary badge-lg">@Model.Status</span>
                                            break;
                                    }
                                </p>
                                @if (!string.IsNullOrEmpty(Model.TeacherComment))
                                {
                                    <p><strong>Đã có nhận xét:</strong> <i class="fas fa-check text-success"></i></p>
                                }
                                else
                                {
                                    <p><strong>Nhận xét:</strong> <span class="text-muted">Chưa có</span></p>
                                }
                            </div>
                        </div>
                    </div>

                    <!-- Nội dung bài làm -->
                    <div class="card mb-4 inner-card">
                        <div class="card-header gradient-secondary text-white">
                            <h5 class="mb-0"><i class="fas fa-edit"></i> Nội dung bài làm</h5>
                        </div>
                        <div class="card-body">
                            @if (!string.IsNullOrEmpty(Model.StudentAnswer))
                            {
                                <div class="border p-3 bg-light rounded">
                                    <pre style="white-space: pre-wrap; font-family: inherit;">@Model.StudentAnswer</pre>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-info small">
                                    <i class="fas fa-info-circle"></i> Học sinh chưa nhập nội dung văn bản.
                                </div>
                            }
                        </div>
                    </div>

                    <!-- File đính kèm -->
                    @if (!string.IsNullOrEmpty(Model.AttachmentFilePath))
                    {
                        <div class="card mb-4 inner-card">
                            <div class="card-header gradient-secondary text-white">
                                <h5 class="mb-0"><i class="fas fa-paperclip"></i> File đính kèm</h5>
                            </div>
                            <div class="card-body">
                                @{
                                    var fileName = Model.AttachmentFilePath.Split('/').LastOrDefault() ?? Model.AttachmentFilePath;
                                    var lastDot = fileName.LastIndexOf('.');
                                    var fileExtension = lastDot >= 0 ? fileName.Substring(lastDot).ToLower() : "";
                                    var isImage = new[] { ".jpg", ".jpeg", ".png", ".gif", ".bmp" }.Contains(fileExtension);
                                    var isPdf = fileExtension == ".pdf";
                                    var isDoc = new[] { ".doc", ".docx" }.Contains(fileExtension);
                                }

                                <div class="d-flex align-items-center mb-3 file-info">
                                    @if (isImage)
                                    {
                                        <i class="fas fa-image fa-2x icon-file text-success me-3"></i>
                                    }
                                    else if (isPdf)
                                    {
                                        <i class="fas fa-file-pdf fa-2x icon-file text-danger me-3"></i>
                                    }
                                    else if (isDoc)
                                    {
                                        <i class="fas fa-file-word fa-2x icon-file text-primary me-3"></i>
                                    }
                                    else
                                    {
                                        <i class="fas fa-file fa-2x icon-file text-info me-3"></i>
                                    }
                                    <div>
                                        <h6 class="mb-1 file-name">@fileName</h6>
                                        <small class="text-muted file-ext">@fileExtension?.ToUpper() file</small>
                                    </div>
                                </div>

                                <div class="d-flex flex-wrap gap-2">
                                    <a asp-action="DownloadAttachment" asp-route-fileName="@fileName" class="btn btn-outline-primary btn-action">
                                        <i class="fas fa-download"></i> Tải về
                                    </a>

                                    @if (isImage)
                                    {
                                        <button type="button" class="btn btn-outline-info btn-action" onclick="previewImage('@fileName')">
                                            <i class="fas fa-eye"></i> Xem trước
                                        </button>
                                    }
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Nhận xét của giáo viên -->
                    <div class="card mb-4 inner-card">
                        <div class="card-header gradient-success text-white">
                            <h5 class="mb-0"><i class="fas fa-comments"></i> Nhận xét của giáo viên</h5>
                        </div>
                        <div class="card-body">
                            @if (!string.IsNullOrEmpty(Model.TeacherComment))
                            {
                                <div class="border p-3 bg-light rounded">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-quote-left text-success me-2 mt-1"></i>
                                        <div>
                                            <pre style="white-space: pre-wrap; font-family: inherit; margin: 0;">@Model.TeacherComment</pre>
                                        </div>
                                        <i class="fas fa-quote-right text-success ms-2 mt-1"></i>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-warning small">
                                    <i class="fas fa-exclamation-triangle"></i> Giáo viên chưa có nhận xét cho bài làm này.
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="card">
                        <div class="card-body text-center actions-row">
                            <a href="javascript:history.back()" class="btn btn-secondary me-2 btn-action">
                                <i class="fas fa-arrow-left"></i> Quay lại
                            </a>

                            <a asp-controller="EssaySubmission" asp-action="ViewSubmissions"
                               asp-route-exerciseId="@Model.ExerciseId" class="btn btn-info btn-action">
                                <i class="fas fa-list"></i> Xem tất cả bài nộp
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Preview Modal -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Xem trước hình ảnh</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body text-center">
                <img id="previewImage" src="" class="img-fluid" alt="Preview" />
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function previewImage(fileName) {
            document.getElementById('previewImage').src = `/uploads/essays/${fileName}`;
            $('#imageModal').modal('show');
        }
    </script>

    <style>
        /* small overrides kept inline for fast tweak */
        .file-name { font-weight: 700; }
        .file-ext { font-style: italic; color: #64748b; }
    </style>
}