@using System.IO
@model LearnX_App.Models.EssaySubmissionListViewModel

@{
    ViewData["Title"] = "Danh sách bài nộp";
    var submissionsList = Model.Submissions?.OrderByDescending(s => s.SubmittedAt).ToList()
                           ;
}

<link rel="stylesheet" href="~/css/submission/viewSubmissions.css" />

<div class="page-container">
    <!-- Page Header -->
    <header class="page-header">
        <div class="header-top">
            <div class="header-title-section">
                <div class="header-icon"><i class="fas fa-file-alt"></i></div>
                <div class="header-text">
                    <h1 class="page-title">@Model.ExerciseTitle</h1>
                    <p class="page-subtitle">
                        @if (Model.IsTeacher)
                        {
                            <span>Danh sách bài nộp của học viên</span>
                        }
                        else
                        {

                            <span>Lịch sử nộp bài của bạn</span>
                        }
                    </p>
                </div>
            </div>

            <div class="header-actions">
                <a href="@Url.Action("Details", "Exercise", new { id = Model.ExerciseId })" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Quay lại
                </a>

                @if (!Model.IsTeacher)
                {
                    <a href="@Url.Action("DoExercise", "Exercise", new { exerciseId = Model.ExerciseId })"
                        class="btn btn-primary">
                        <i class="fas fa-plus"></i> Nộp bài mới
                    </a>
                }
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon total"><i class="fas fa-file-alt"></i></div>
                <div class="stat-content">
                    <p class="stat-value" id="totalCount">@submissionsList.Count</p>
                    <p class="stat-label">Tổng bài nộp</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon graded"><i class="fas fa-check-circle"></i></div>
                <div class="stat-content">
                    <p class="stat-value" id="gradedCount">@submissionsList.Count(s => s.Status == "Graded")</p>
                    <p class="stat-label">Đã chấm</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon pending"><i class="fas fa-clock"></i></div>
                <div class="stat-content">
                    <p class="stat-value" id="pendingCount">@submissionsList.Count(s => s.Status == "Submitted")</p>
                    <p class="stat-label">Chờ chấm</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon reviewed"><i class="fas fa-star"></i></div>
                <div class="stat-content">
                    <p class="stat-value" id="reviewedCount">@submissionsList.Count(s => s.Status == "Reviewed")</p>
                    <p class="stat-label">Đã duyệt</p>
                </div>
            </div>
        </div>
    </header>

    <section class="filter-section">
        <div class="filter-controls">
            <div class="filter-group">
                <label class="filter-label" for="statusFilter"><i class="fas fa-filter"></i> Trạng thái</label>
                <select id="statusFilter" class="filter-select" onchange="filterSubmissions()">
                    <option value="all">Tất cả</option>
                    <option value="Submitted">Chờ chấm</option>
                    <option value="Graded">Đã chấm</option>
                    <option value="Reviewed">Đã duyệt</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label" for="sortFilter"><i class="fas fa-sort"></i> Sắp xếp</label>
                <select id="sortFilter" class="filter-select" onchange="filterSubmissions()">
                    <option value="newest">Mới nhất</option>
                    <option value="oldest">Cũ nhất</option>
                    <option value="attempt">Số lần nộp</option>
                </select>
            </div>

            @if (Model.IsTeacher)
            {
                <div class="search-box">
                    <label class="filter-label"><i class="fas fa-search"></i> Tìm kiếm học viên</label>
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="searchInput" class="search-input" placeholder="Nhập tên học viên..."
                        oninput="filterSubmissions()" />
                </div>
            }
        </div>
    </section>

    <!-- Submissions List -->
    @if (!submissionsList.Any())
    {
        <div class="empty-state">
            <div class="empty-icon"><i class="fas fa-inbox"></i></div>
            <h2 class="empty-title">Chưa có bài nộp nào</h2>
            <p class="empty-message">
                @if (Model.IsTeacher)
                {
                    <span>Chưa có học viên nào nộp bài tập này.</span>
                }
                else
                {

                    <span>Bạn chưa nộp bài tập này. Hãy nộp bài đầu tiên của bạn!</span>
                }
            </p>
        </div>
    }
    else
    {
        <div class="submissions-container" id="submissionsContainer">
            @for (int i = 0; i < submissionsList.Count; i++)
            {
                var submission = submissionsList[i];
                var fileName = submission.AttachmentFilePath?.Split('/').LastOrDefault() ?? "";
                var studentName = submission.User?.UserName ?? "unknown";
                <article class="submission-card" data-status="@submission.Status" data-student="@studentName"
                    data-date="@submission.SubmittedAt.Ticks" data-attempt="@submission.AttemptNumber"
                    style="animation-delay: @(i * 0.05)s">
                    <div class="submission-header">
                        <div class="student-info">
                            <div class="student-avatar">@(studentName.Length > 0 ? studentName.Substring(0, 1).ToUpper() : "?")
                            </div>
                            <div class="student-details">
                                <h3 class="student-name">@studentName</h3>
                                <div class="submission-meta">
                                    <span class="meta-item"><i class="fas fa-calendar"></i>
                                        @submission.SubmittedAt.ToString("dd/MM/yyyy HH:mm")</span>
                                    <span class="meta-item"><i class="fas fa-redo"></i> Lần @submission.AttemptNumber</span>
                                </div>
                            </div>
                        </div>

                        <div class="status-badge @submission.Status?.ToLower()">
                            @if (submission.Status == "Submitted")
                            {
                                <i class="fas fa-clock"></i>
                                <span>Chờ chấm</span>
         }
                            else if (submission.Status == "Graded")
                            {
                                <i class="fas fa-check-circle"></i>
                                <span>Đã chấm</span>
         }
                            else if (submission.Status == "Reviewed")
                            {
                                <i class="fas fa-star"></i>
                                <span>Đã duyệt</span>
         }
                        </div>
                    </div>

                    <div class="submission-content">
                        <label class="content-label">Câu trả lời:</label>
                        <div class="answer-text">@Html.Raw(submission.StudentAnswer ?? "Không có nội dung")</div>

                        @if (!string.IsNullOrEmpty(submission.AttachmentFilePath))
                        {
                            <div class="attachment-section">
                                <a href="@submission.AttachmentFilePath" class="attachment-link" target="_blank">
                                    <i class="fas fa-paperclip"></i> Xem file đính kèm
                                </a>
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(submission.TeacherComment))
                        {
                            <div class="comment-section">
                                <div class="comment-header"><i class="fas fa-comment-dots"></i> Nhận xét của giảng viên:</div>
                                <div class="comment-text">@Html.Raw(submission.TeacherComment)</div>
                            </div>
                        }
                    </div>

                    <div class="submission-actions">
                        @if (Model.IsTeacher)
                        {
                            <button type="button" class="btn btn-grade"
    data-submission-id="@submission.Id"
    data-teacher-comment='@Html.Raw(System.Text.Json.JsonSerializer.Serialize(submission.TeacherComment ?? ""))'
    data-status="@(submission.Status ?? "Submitted")"
    onclick="openGradeModalFromButton(this)">
    <i class="fas fa-pen"></i> Chấm điểm
</button>
                        }

                        <a href="@Url.Action("ViewSubmissionDetail", "EssaySubmission", new { id = submission.Id })"
                            class="btn btn-view">
                            <i class="fas fa-eye"></i> Xem chi tiết
                        </a>
                    </div>
                </article>
            }
        </div>
    }

    <!-- Grade Modal -->
    @if (Model.IsTeacher)
    {
        <div class="modal-overlay" id="gradeModal" aria-hidden="true">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">
                        <div class="modal-icon"><i class="fas fa-graduation-cap"></i></div>
                        Chấm điểm bài tập
                    </h2>
                    <button type="button" class="modal-close" onclick="closeGradeModal()"><i
                            class="fas fa-times"></i></button>
                </div>

                <div class="modal-body">
                    <input type="hidden" id="submissionId" />
                    <div class="form-group">
                        <label for="teacherComment" class="form-label"><i class="fas fa-comment-dots"></i> Nhận xét</label>
                        <textarea id="teacherComment" class="form-control" placeholder="Nhập nhận xét của bạn..."
                        rows="5"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="statusSelect" class="form-label"><i class="fas fa-flag"></i> Trạng thái</label>
                        <select id="statusSelect" class="form-control">
                            <option value="Graded">Đã chấm</option>
                            <option value="Reviewed">Đã duyệt</option>
                        </select>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-cancel" onclick="closeGradeModal()"><i class="fas fa-times"></i>
                        Hủy</button>
                    <button type="button" class="btn btn-save" onclick="submitGrade()"><i class="fas fa-save"></i> Lưu đánh
                        giá</button>
                </div>
            </div>
        </div>
    }

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast" role="status" aria-live="polite">
        <div class="toast-icon"><i class="fas fa-check"></i></div>
        <div class="toast-content">
            <p class="toast-title" id="toastTitle">Thành công</p>
            <p class="toast-message" id="toastMessage">Đã lưu thay đổi</p>
        </div>
    </div>
</div>

@section Scripts {
    <script>
   
         function filterSubmissions() {
            const statusFilter = document.getElementById('statusFilter').value;
            const sortFilter = document.getElementById('sortFilter').value;
            const searchInput = document.getElementById('searchInput')?.value.toLowerCase() || '';
            const cards = Array.from(document.querySelectorAll('.submission-card'));

            // Filter by status and search
            cards.forEach(card => {
                const status = card.getAttribute('data-status');
                const student = card.getAttribute('data-student').toLowerCase();
                
                const matchesStatus = statusFilter === 'all' || status === statusFilter;
                const matchesSearch = student.includes(searchInput);
                
                if (matchesStatus && matchesSearch) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });

            // Sort visible cards
            const visibleCards = cards.filter(card => card.style.display !== 'none');
            
            visibleCards.sort((a, b) => {
                if (sortFilter === 'newest') {
                    return parseInt(b.getAttribute('data-date')) - parseInt(a.getAttribute('data-date'));
                } else if (sortFilter === 'oldest') {
                    return parseInt(a.getAttribute('data-date')) - parseInt(b.getAttribute('data-date'));
                } else if (sortFilter === 'attempt') {
                    return parseInt(b.getAttribute('data-attempt')) - parseInt(a.getAttribute('data-attempt'));
                }
                return 0;
            });

            // Reorder DOM
            const container = document.getElementById('submissionsContainer');
            visibleCards.forEach(card => {
                container.appendChild(card);
            });
        }

        // Open grade modal
        function openGradeModal(submissionId, comment, status) {
            document.getElementById('submissionId').value = submissionId;
            document.getElementById('teacherComment').value = comment || '';
            document.getElementById('statusSelect').value = status || 'Graded';
            document.getElementById('gradeModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // Open grade modal from button
        function openGradeModalFromButton(btn) {
    try {
        const submissionId = btn.getAttribute('data-submission-id');
        const rawComment = btn.getAttribute('data-teacher-comment') || '""';
        // parse safe JSON (teacherComment serialized on server-side)
        let comment = '';
        try { comment = JSON.parse(rawComment); } catch (e) { comment = rawComment; }

        const status = btn.getAttribute('data-status') || 'Graded';

        // reuse existing openGradeModal which expects (id, comment, status)
        openGradeModal(submissionId, comment, status);
    } catch (err) {
        console.error('openGradeModalFromButton error', err);
    }
}

        // Close grade modal
        function closeGradeModal() {
            document.getElementById('gradeModal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // Submit grade
        async function submitGrade() {
           const submissionId = document.getElementById('submissionId').value;
            const comment = document.getElementById('teacherComment').value.trim();
            const status = document.getElementById('statusSelect').value;

            if (!comment) {
                showToast('error', 'Lỗi', 'Vui lòng nhập nhận xét');
                return;
            }

            showLoading();

            try {
                const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';

                const res = await fetch(`/EssaySubmission/AddTeacherComment/${submissionId}`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json',
                        'RequestVerificationToken': token
                    },
                    body: new FormData(document.createElement('form')) // we'll append fields below
                });

                // Use separate FormData to send fields
                const fd = new FormData();
                fd.append('comment', comment);

                const res1 = await fetch(`/EssaySubmission/AddTeacherComment/${submissionId}`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json',
                        'RequestVerificationToken': token
                    },
                    body: fd
                });

                const ct1 = res1.headers.get('content-type') || '';
                if (!ct1.includes('application/json')) {
                    const txt = await res1.text();
                    throw new Error('Server trả về không phải JSON: ' + txt);
                }

                const data1 = await res1.json();
                if (!data1.success) throw new Error(data1.message || 'Add comment failed');

                const fd2 = new FormData();
                fd2.append('status', status);

                const res2 = await fetch(`/EssaySubmission/UpdateStatus/${submissionId}`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json',
                        'RequestVerificationToken': token
                    },
                    body: fd2
                });

                const ct2 = res2.headers.get('content-type') || '';
                if (!ct2.includes('application/json')) {
                    const txt2 = await res2.text();
                    throw new Error('Server trả về không phải JSON: ' + txt2);
                }

                const data2 = await res2.json();
                if (!data2.success) throw new Error(data2.message || 'Update status failed');

                hideLoading();
                showToast('success', 'Thành công', 'Đã lưu đánh giá thành công');
                closeGradeModal();
                setTimeout(() => location.reload(), 1000);
            } catch (err) {
                hideLoading();
                showToast('error', 'Lỗi', err.message || 'Đã xảy ra lỗi');
            }
        }

        // Show toast notification
        function showToast(type, title, message) {
            const toast = document.getElementById('toast');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = toast.querySelector('.toast-icon i');

            toast.className = 'toast ' + type;
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            
            if (type === 'success') {
                toastIcon.className = 'fas fa-check';
            } else if (type === 'error') {
                toastIcon.className = 'fas fa-times';
            }

            toast.classList.add('active');

            setTimeout(() => {
                toast.classList.remove('active');
            }, 4000);
        }

        // Show loading overlay
        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        // Hide loading overlay
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        // Close modal on outside click
        document.getElementById('gradeModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeGradeModal();
            }
        });

        // Close modal on ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeGradeModal();
            }
        });
    </script>
}