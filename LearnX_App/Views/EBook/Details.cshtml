@model EBook

@using LearnX_Data.Entities

@using System.IO


<link href="~/css/ebook/details.css" rel="stylesheet">

<div class="container my-5">
    <div class="row">
        <!-- YouTube Video Section -->
        @if (!string.IsNullOrEmpty(Model.LinkYoutube))
        {
            <div class="col-12 mb-4">
                <div class="video-container">
                    <div class="video-info">
                        <h5><i class="fab fa-youtube"></i> Video Tutorial</h5>
                        <p>Watch the video tutorial related to this book</p>
                    </div>
                    <div class="youtube-embed">
                        <iframe src="https://www.youtube.com/embed/@Model.LinkYoutube" title="YouTube video player"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                            allowfullscreen>
                        </iframe>
                    </div>
                </div>
            </div>
        }

        <!-- Content Reader -->
        <div class="col-lg-8">
            <div class="content-tabs">
                <!-- Tab navigation -->
                <ul class="nav nav-tabs" id="contentTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="book-tab" data-bs-toggle="tab"
                            data-bs-target="#book-content" type="button" role="tab">
                            <i class="fas fa-book-open"></i> Read Book
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="info-tab" data-bs-toggle="tab" data-bs-target="#book-info"
                            type="button" role="tab">
                            <i class="fas fa-info-circle"></i> Book Info
                        </button>
                    </li>
                </ul>

                <!-- Tab content -->
                <div class="tab-content" id="contentTabsContent">
                    <!-- Book reading tab -->
                    <div class="tab-pane fade show active" id="book-content" role="tabpanel">
                        <h2 class="mb-3"><i class="fas fa-book-open"></i> @Model.Title</h2>
                        <p class="text-muted mb-4">@Model.Description</p>

                        @if (!string.IsNullOrEmpty(Model.FilePath))
                        {
                            <div id="pdf-viewer" class="pdf-viewer"></div>

                            <div class="mt-4 d-flex justify-content-between align-items-center flex-wrap gap-2">
                                <a href="@Url.Action("Download", "EBooks", new { id = Model.Id })" class="btn btn-primary">
                                    <i class="fas fa-download"></i> Download Book
                                </a>
                                <a href="@Url.Action("Index", "EBook")" class="btn btn-outline-secondary">
                                    <i class="fas fa-arrow-left"></i> Back to List
                                </a>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-danger mt-3">
                                <strong>Notice:</strong> No file available for this book.
                            </div>
                        }
                    </div>

                    <!-- Book info tab -->
                    <div class="tab-pane fade" id="book-info" role="tabpanel">
                        <h5 class="mb-4"><i class="fas fa-info-circle"></i> Book Information</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <strong><i class="fas fa-book"></i> Title:</strong>
                                    <p class="ms-3">@Model.Title</p>
                                </div>
                                <div class="mb-3">
                                    <strong><i class="fas fa-calendar"></i> Uploaded:</strong>
                                    <p class="ms-3">@Model.UploadedAt.ToString("dd/MM/yyyy HH:mm")</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <strong><i class="fas fa-file-pdf"></i> File Path:</strong>
                                    <p class="ms-3">@Model.FilePath</p>
                                </div>
                                @if (!string.IsNullOrEmpty(Model.LinkYoutube))
                                {
                                    <div class="mb-3">
                                        <strong><i class="fab fa-youtube"></i> YouTube Link:</strong>
                                        <p class="ms-3">
                                            <a href="https://www.youtube.com/watch?v=@Model.LinkYoutube" target="_blank"
                                                class="text-decoration-none">
                                                Watch on YouTube <i class="fas fa-external-link-alt"></i>
                                            </a>
                                        </p>
                                    </div>
                                }
                            </div>
                            <div class="col-12">
                                <div class="mb-3">
                                    <strong><i class="fas fa-align-left"></i> Description:</strong>
                                    <p class="ms-3">@Model.Description</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4 mt-4 mt-lg-0">
            <div class="book-sidebar">
                <h5 class="mb-3"><i class="fas fa-bookmark"></i> Quick Info</h5>
                <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-book text-primary me-2"></i>
                    <small class="text-muted">Title:</small>
                </div>
                <p class="fw-bold mb-3">@Model.Title</p>

                <div class="d-flex align-items-center mb-3">
                    <i class="fas fa-calendar text-success me-2"></i>
                    <small class="text-muted">Uploaded:</small>
                </div>
                <p class="ms-3">@Model.UploadedAt.ToString("dd/MM/yyyy HH:mm")
</p>

                @if (!string.IsNullOrEmpty(Model.LinkYoutube))
                {
                    <div class="d-flex align-items-center mb-3">
                        <i class="fab fa-youtube text-danger me-2"></i>
                        <small class="text-muted">Video Available:</small>
                    </div>
                    <div class="alert alert-info">
                        <i class="fab fa-youtube"></i> This book has a video tutorial!
                    </div>
                }

                <hr>
                <div class="d-grid gap-2">
                    @if (!string.IsNullOrEmpty(Model.FilePath))
                    {
                        <a href="@Url.Action("Download", "EBooks", new { id = Model.Id })"
                            class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-download"></i> Download PDF
                        </a>
                    }
                    @if (!string.IsNullOrEmpty(Model.LinkYoutube))
                    {
                        <a href="https://www.youtube.com/watch?v=@Model.LinkYoutube" target="_blank"
                            class="btn btn-outline-danger btn-sm">
                            <i class="fab fa-youtube"></i> Watch on YouTube
                        </a>
                    }
                    <a href="@Url.Action("Index", "EBook")" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left"></i> Back to List
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap & PDF.js Scripts -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

<script>
    // ensure worker is set
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

    const cloudUrl = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.FilePath ?? ""));
    if (cloudUrl) {
        const proxyBase = '@Url.Action("RedirectTo", "EBook")'; // <-- dùng Url.Action để sinh đường dẫn đúng
        const url = proxyBase + '?url=' + encodeURIComponent(cloudUrl);
        const container = document.getElementById('pdf-viewer');

        const loadingTask = pdfjsLib.getDocument({ url: url, withCredentials: false });
        loadingTask.promise.then(function (pdf) {
            for (let pageNumber = 1; pageNumber <= pdf.numPages; pageNumber++) {
                pdf.getPage(pageNumber).then(function (page) {
                    const scale = 1.2;
                    const viewport = page.getViewport({ scale: scale });

                    const canvas = document.createElement("canvas");
                    const context = canvas.getContext("2d");
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    canvas.style.maxWidth = '100%';

                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport
                    };

                    page.render(renderContext).promise.then(function () {
                        container.appendChild(canvas);
                    });
                });
            }
        }).catch(function (error) {
            container.innerHTML = `<div class="alert alert-danger">Error loading PDF: ${error.message}</div>`;
        });
    }
</script>