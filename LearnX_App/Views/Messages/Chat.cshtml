@model IEnumerable<LearnX_ModelView.Catalog.Messages.ConversationSummary>
@using System
@using LearnX_ModelView.Catalog.Messages

<link href="~/css/mess/chat.css" rel="stylesheet"/>
<div class="messenger-container">
    <!-- Sidebar - Conversations List -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1 class="sidebar-title"><i class="fas fa-comment-dots"></i> ƒêo·∫°n chat</h1>
            <div class="sidebar-actions">
                <button class="icon-btn" title="Tin nh·∫Øn m·ªõi"><i class="fas fa-edit"></i></button>
                <button class="icon-btn" title="C√†i ƒë·∫∑t"><i class="fas fa-cog"></i></button>
            </div>
        </div>
        <div class="search-box">
            <div class="search-wrapper">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" placeholder="T√¨m ki·∫øm tr√™n Messenger" id="searchConversations"/>
            </div>
        </div>
        <div class="conversations-list" id="conversationsList">
            @if (Model != null && Model.Any())
            {
                foreach (var conversation in Model)
                {
                    var initial = !string.IsNullOrEmpty(conversation.Email) ? conversation.Email.Substring(0, 1).ToUpper() : "U";
                    var timeAgo = GetTimeAgo(conversation.LatestAt);
                    var unreadClass = conversation.UnreadCount > 0 ? "unread" : "";
            <div class="conversation-item @unreadClass" data-user-id="@conversation.UserId" data-email="@conversation.Email"
                onclick="openChat(event, '@conversation.UserId', '@conversation.Email')">
                <div class="conversation-avatar">
                    <div class="avatar">@initial</div>
                    <div class="online-indicator"></div>
                </div>
                <div class="conversation-content">
                    <div class="conversation-header">
                        <span class="conversation-name">@conversation.Email</span>
                        <span class="conversation-time">@timeAgo</span>
                    </div>
                    <div class="conversation-preview">
                        <span class="preview-text">@(conversation.LatestMessage ?? "B·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán")</span>
                        @if (conversation.UnreadCount > 0)
                        {
                            <span class="unread-badge">@conversation.UnreadCount</span>
                        }
                    </div>
                </div>
            </div>
                }
            }
            else
            {
            <div class="empty-chat">
                <div class="empty-icon"><i class="fas fa-comments"></i></div>
                <h3 class="empty-title">Ch∆∞a c√≥ cu·ªôc tr√≤ chuy·ªán</h3>
                <p class="empty-text">B·∫Øt ƒë·∫ßu tr√≤ chuy·ªán v·ªõi ai ƒë√≥!</p>
            </div>
            }
        </div>
    </aside>
    <!-- Chat Area -->
    <main class="chat-area" id="chatArea">
        <div class="empty-chat">
            <div class="empty-icon"><i class="fas fa-comments"></i></div>
            <h3 class="empty-title">Ch·ªçn m·ªôt cu·ªôc tr√≤ chuy·ªán</h3>
            <p class="empty-text">Ch·ªçn t·ª´ danh s√°ch b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu tr√≤ chuy·ªán</p>
        </div>
    </main>
</div>

<script>
    const currentUserId = '@ViewBag.UserId';
    let currentChatUserId = null;
    let currentChatUserEmail = null;

    // Open chat with user
    async function openChat(event, userId, email) {
        currentChatUserId = userId;
        currentChatUserEmail = email;
        // Update active conversation
        document.querySelectorAll('.conversation-item').forEach(item => {
            item.classList.remove('active');
        });
        if (event && event.currentTarget) {
            event.currentTarget.classList.add('active');
        }
        // Mobile: hide sidebar when chat is opened
        if (window.innerWidth <= 768) {
            document.getElementById('sidebar').classList.add('hidden');
        }
        // Load chat messages
        await loadChatMessages(userId);
        // Mark messages as read
        markConversationAsRead(userId);
    }

    // Load chat messages
    async function loadChatMessages(userId) {
        const chatArea = document.getElementById('chatArea');
        const initial = currentChatUserEmail
            ? currentChatUserEmail.substring(0, 1).toUpperCase()
            : "";
        chatArea.innerHTML = `
            <div class="chat-header">
                <div class="chat-user-info">
                    <button class="icon-btn" onclick="backToList()" style="margin-right: 8px; display: none;" id="backBtn">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="chat-user-avatar">${initial}</div>
                    <div class="chat-user-details">
                        <div class="chat-user-name">${currentChatUserEmail}</div>
                        <div class="chat-user-status online">
                            <i class="fas fa-circle" style="font-size: 0.5rem;"></i>
                            ƒêang ho·∫°t ƒë·ªông
                        </div>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="action-icon-btn" title="G·ªçi tho·∫°i">
                        <i class="fas fa-phone"></i>
                    </button>
                    <button class="action-icon-btn" title="G·ªçi video">
                        <i class="fas fa-video"></i>
                    </button>
                    <button class="action-icon-btn" title="Th√¥ng tin">
                        <i class="fas fa-info-circle"></i>
                    </button>
                </div>
            </div>
            <div class="messages-container" id="messagesContainer">
                <div style="text-align: center; padding: 40px 20px;">
                    <div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); margin: 0 auto 16px; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; font-weight: 700;">
                        ${initial}
                    </div>
                    <h3 style="font-size: 1.5rem; font-weight: 700; color: #050505; margin: 0 0 8px 0;">${currentChatUserEmail}</h3>
                    <p style="font-size: 0.9rem; color: #65676b; margin: 0 0 16px 0;">C√°c b·∫°n l√† b·∫°n b√® tr√™n Messenger</p>
                    <p style="font-size: 0.85rem; color: #65676b;">B·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán c·ªßa b·∫°n!</p>
                </div>
            </div>
            <div class="message-input-area">
                <div class="input-wrapper">
                    <div class="input-actions">
                        <button class="attach-btn" title="ƒê√≠nh k√®m file"><i class="fas fa-plus-circle"></i></button>
                        <button class="attach-btn" title="G·ª≠i ·∫£nh"><i class="fas fa-image"></i></button>
                        <button class="attach-btn" title="G·ª≠i sticker"><i class="fas fa-sticky-note"></i></button>
                    </div>
                    <div class="message-input-wrapper">
                        <textarea class="message-input" id="messageInput" placeholder="Aa" rows="1"></textarea>
                        <button class="emoji-btn" title="Ch·ªçn emoji">üòä</button>
                    </div>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        `;
        // Show back button on mobile
        if (window.innerWidth <= 768) {
            document.getElementById('backBtn').style.display = 'flex';
        }
        // Setup message input
        setupMessageInput();
        // Load actual messages from server
        try {
            const response = await fetch(`/Message/GetConversation?otherUserId=${userId}`);
            if (response.ok) {
                const messages = await response.json();
                displayMessages(messages);
            }
        } catch (error) {
            console.error('Error loading messages:', error);
        }
    }

    // Display messages
    function displayMessages(messages) {
        const container = document.getElementById('messagesContainer');
        if (!messages || messages.length === 0) {
            container.innerHTML = "";
            return;
        }
        let html = '';
        let lastDate = '';
        messages.forEach((msg, index) => {
            const thisDate = new Date(msg.sentAt);
            const messageDate = thisDate.toDateString();
            const messageTime = thisDate.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            const isSent = msg.senderId === currentUserId;
            const initial = isSent ? 'B' : (currentChatUserEmail ? currentChatUserEmail.substring(0, 1).toUpperCase() : "U");
            // Add date divider
            if (messageDate !== lastDate) {
                html += `<div class="date-divider"><span>${formatDate(thisDate)}</span></div>`;
                lastDate = messageDate;
            }
            // Add message
            html += `
                <div class="message-group ${isSent ? 'sent' : 'received'}">
                    ${!isSent ? `<div class="message-avatar">${initial}</div>` : ''}
                    <div class="message-content-wrapper">
                        <div class="message-bubble">${escapeHtml(msg.content)}</div>
                        <div class="message-time">
                            ${messageTime}
                            ${isSent && msg.isRead ? '<i class="fas fa-check-double" style="color: #0084ff;"></i>' : ''}
                            ${isSent && !msg.isRead ? '<i class="fas fa-check"></i>' : ''}
                        </div>
                    </div>
                    ${isSent ? `<div class="message-avatar">${initial}</div>` : ''}
                </div>
            `;
        });
        container.innerHTML = html;
        scrollToBottom();
    }

    // Setup message input
    function setupMessageInput() {
        const input = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        if (!input || !sendBtn) return;
        input.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            sendBtn.disabled = this.value.trim() === '';
        });
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (this.value.trim() !== '') {
                    sendMessage();
                }
            }
        });
    }

    // Send message
    async function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        if (!message || !currentChatUserId) return;
        try {
            const response = await fetch('/Message/Send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    receiverId: currentChatUserId,
                    content: message
                })
            });
            if (response.ok) {
                input.value = '';
                input.style.height = 'auto';
                document.getElementById('sendBtn').disabled = true;
                await loadChatMessages(currentChatUserId);
                updateConversationPreview(currentChatUserId, message);
            }
        } catch (error) {
            console.error('Error sending message:', error);
        }
    }

    // Mark conversation as read
    function markConversationAsRead(userId) {
        const conversation = document.querySelector(`.conversation-item[data-user-id="${userId}"]`);
        if (conversation) {
            conversation.classList.remove('unread');
            const badge = conversation.querySelector('.unread-badge');
            if (badge) {
                badge.remove();
            }
        }
    }

    // Update conversation preview
    function updateConversationPreview(userId, message) {
        const conversation = document.querySelector(`.conversation-item[data-user-id="${userId}"]`);
        if (conversation) {
            const previewText = conversation.querySelector('.preview-text');
            const timeSpan = conversation.querySelector('.conversation-time');
            if (previewText) {
                previewText.textContent = message;
            }
            if (timeSpan) {
                timeSpan.textContent = 'V·ª´a xong';
            }
            // Move to top
            const list = document.getElementById('conversationsList');
            list.insertBefore(conversation, list.firstChild);
        }
    }

    // Search conversations
    document.getElementById('searchConversations')?.addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const conversations = document.querySelectorAll('.conversation-item');
        conversations.forEach(conv => {
            const email = (conv.dataset.email || "").toLowerCase();
            const preview = (conv.querySelector('.preview-text')?.textContent || "").toLowerCase();
            if (email.includes(searchTerm) || preview.includes(searchTerm)) {
                conv.style.display = 'flex';
            } else {
                conv.style.display = 'none';
            }
        });
    });

    // Back to list (mobile)
    function backToList() {
        document.getElementById('sidebar').classList.remove('hidden');
    }

    // Utility functions
    function scrollToBottom() {
        const container = document.getElementById('messagesContainer');
        if (container) {
            container.scrollTop = container.scrollHeight;
        }
    }
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    function formatDate(date) {
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        if (date.toDateString() === today.toDateString()) {
            return 'H√¥m nay';
        } else if (date.toDateString() === yesterday.toDateString()) {
            return 'H√¥m qua';
        } else {
            return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }
    }

    // Handle window resize
    window.addEventListener('resize', function() {
        if (window.innerWidth > 768) {
            document.getElementById('sidebar').classList.remove('hidden');
            const backBtn = document.getElementById('backBtn');
            if (backBtn) {
                backBtn.style.display = 'none';
            }
        } else if (currentChatUserId) {
            const backBtn = document.getElementById('backBtn');
            if (backBtn) {
                backBtn.style.display = 'flex';
            }
        }
    });

</script>
@functions {
    // H√†m t√≠nh th·ªùi gian ƒë√£ tr√¥i qua k·ªÉ t·ª´ sentAt (ƒë·ªãnh d·∫°ng ti·∫øng Vi·ªát ƒë∆°n gi·∫£n)
    public static string GetTimeAgo(DateTime sentAt)
    {
        var timeSpan = DateTime.Now - sentAt;
        if (timeSpan.TotalMinutes < 1)
            return "V·ª´a xong";
        if (timeSpan.TotalMinutes < 60)
            return $"{(int)timeSpan.TotalMinutes} ph√∫t";
        if (timeSpan.TotalHours < 24)
            return $"{(int)timeSpan.TotalHours} gi·ªù";
        if (timeSpan.TotalDays < 7)
            return $"{(int)timeSpan.TotalDays} ng√†y";
        return sentAt.ToString("dd/MM");
    }
}