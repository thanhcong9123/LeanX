@using LearnX_ModelView.Catalog.PayMent
@model UpgradePaymentViewModel
@{
    ViewData["Title"] = "Thanh toán bằng Momo";
}

<h2>Thanh toán</h2>

<div>
    <p>Gói: <strong>@Model.PackageName</strong></p>
    <p>Số tiền: <strong>@Model.Amount</strong> VND</p>
    <p>Mã đơn hàng: <strong>@Model.OrderId</strong></p>
</div>

<div id="qrcode" style="width:220px; height:220px; margin-bottom:10px;"></div>

<p>
    <a id="openLink" class="btn btn-success" target="_blank">Mở trong Momo / Trình duyệt</a>
    <button id="refreshStatusBtn" class="btn btn-secondary">Kiểm tra trạng thái</button>
</p>

<div id="statusMessage" class="mt-3"></div>

<!-- QRCode JS (client-side rendering) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
    const payUrl = '@Model.PayUrl';
    const orderId = '@Model.OrderId';

    // Render QR
    new QRCode(document.getElementById("qrcode"), {
        text: payUrl,
        width: 200,
        height: 200
    });

    // Set link
    document.getElementById("openLink").href = payUrl;

    // Polling function
    async function checkStatus() {
        try {
            const res = await fetch('@Url.Action("CheckStatus", "Payment")?orderId=' + encodeURIComponent(orderId));
            if (!res.ok) {
                document.getElementById('statusMessage').innerText = 'Lỗi khi kiểm tra trạng thái';
                return;
            }
            const data = await res.json();
            // Expected data.Status values: Pending, Success, Failed
            if (data.status === 'Success' || data.status === 'success') {
                document.getElementById('statusMessage').innerHTML = '<div class="alert alert-success">Thanh toán thành công. Tài khoản đã được nâng cấp.</div>';
                // Redirect to profile or refresh
                setTimeout(() => { window.location.href = '/User/Profile'; }, 2000);
            } else if (data.status === 'Failed' || data.status === 'failed') {
                document.getElementById('statusMessage').innerHTML = '<div class="alert alert-danger">Thanh toán không thành công.</div>';
            } else {
                document.getElementById('statusMessage').innerHTML = '<div class="alert alert-info">Đang chờ thanh toán... (status: ' + data.status + ')</div>';
            }
        } catch (err) {
            console.error(err);
            document.getElementById('statusMessage').innerText = 'Lỗi kết nối.';
        }
    }

    // Start polling every 5 seconds
    const pollInterval = setInterval(checkStatus, 5000);

    // Manual refresh button
    document.getElementById('refreshStatusBtn').addEventListener('click', checkStatus);

    // Stop polling after success/fail check inside checkStatus by redirect
</script>