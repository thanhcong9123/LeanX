@using LearnX_ModelView.Catalog.PayMent
@model UpgradePaymentViewModel
@{
    ViewData["Title"] = "Thanh toán - Quét QR";
}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
<div class="page-container">
    <h2>Thanh toán</h2>
    <p>Gói: <strong>@Model.PackageName</strong></p>
    <p>Số tiền: <strong>@Model.Amount</strong> VND</p>
    <p>Mã đơn hàng: <strong>@Model.OrderId</strong></p>

    <div id="qrcode" style="width:260px;height:260px;margin-bottom:10px;"></div>
    <p>
        <a id="openLink" class="btn btn-success" target="_blank">Mở liên kết thanh toán</a>
    </p>
    <div id="statusMessage"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
    const payUrl = '@Model.PayUrl';
    const orderId = '@Model.OrderId';
    // Render QR
    new QRCode(document.getElementById("qrcode"), { text: payUrl, width: 250, height: 250 });
    document.getElementById("openLink").href = payUrl;

    async function checkStatus() {
        try {
            const res = await fetch('@Url.Action("CheckStatus","Payment")?orderId=' + encodeURIComponent(orderId));
            const data = await res.json();
            if (data.status && (data.status.toLowerCase() === 'success')) {
                document.getElementById('statusMessage').innerHTML = '<div class="alert alert-success">Thanh toán thành công. Tài khoản đã được nâng cấp.</div>';
                setTimeout(()=> window.location.href = '/User/Profile',2000);
            } else if (data.status && data.status.toLowerCase() === 'failed') {
                document.getElementById('statusMessage').innerHTML = '<div class="alert alert-danger">Thanh toán thất bại.</div>';
            } else {
                document.getElementById('statusMessage').innerHTML = '<div class="alert alert-info">Đang chờ thanh toán... (status: '+ (data.status||'Pending') +')</div>';
            }
        } catch (err) {
            console.error(err);
            document.getElementById('statusMessage').innerText = 'Lỗi khi kiểm tra trạng thái';
        }
    }

    // poll every 5s
    const interval = setInterval(checkStatus, 5000);
    // initial
    checkStatus();
</script>